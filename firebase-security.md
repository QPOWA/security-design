
# システム構成-セキュリティの設計案

## 1. ユーザー認証（Firebase Authentication）
- **パスワードポリシー**：Firebase Authenticationのパスワードポリシー機能を活用し、強力なパスワード（例：8文字以上、特殊文字や数字を含む）をユーザーに求める。
- **多要素認証 (MFA)**：MFA（SMSまたはTOTP）を有効にし、特に重要なアクション（例：アカウント設定変更や退会時）では再認証を促す。
 ```
 Firebase で SMS 多要素認証を有効にする手順
 1. Firebase コンソールの [Authentication] > [Sign-in method] ページを開きます。
 2. [詳細] セクションで [SMS 多要素認証] を有効にします。
    また、アプリのテストに使用する電話番号も入力する必要があります。必要に応じて、開発中のスロットリングを回避するためにテスト用の電話番号を登録することを強くおすすめします。
 3. アプリのドメインをまだ承認していない場合は、Firebase コンソールの [認証] > [設定] ページで許可リストに追加します。
```
- **メールアクション**：パスワードの再設定
- **セッション管理**：セッションの有効期限を短く設定し、一定時間ごとに再認証を求める。疑わしいセッションが発生した場合には、Firebaseのセキュリティルールを用いて自動的にセッションを終了させる。
- **認証状態の監視**：異常なログインがあった場合や設定変更が行われた場合、Cloud FunctionsとCloud Messagingを連携させ、ユーザーに通知を送信する。  
>参照リンク：https://firebase.google.com/docs/auth?hl=ja

## 2. APIのセキュリティ (Firebase Cloud Functions)
- **ユーザーロールに基づくアクセス制御**：APIエンドポイントで、ユーザーロールに応じてアクセス権限を管理し、ユーザーが許可されたデータのみアクセスできるようにする。
- **入力データの検証とリクエスト検証**：すべてのリクエストデータをサーバー側で再確認し、クライアントでの改ざんを防ぐ。関数内で受信データをバリデーションし、不正なリクエストがサーバに到達するのを防ぐことで、意図しない動作やデータ破損のリスクを低減する。
- **レートリミット**：重要なエンドポイントにレートリミットを設定し、不正アクセスやブルートフォース攻撃を防止する。
- **セキュリティルールの設定**：FirebaseのセキュリティルールやIAMを使用して、Cloud Functionsのエンドポイントへのアクセスを適切に制御し、認証済みユーザーのみが特定の操作を行えるようにする。
- **ログとモニタリング**：関数実行時のエラーログやアクセスログを監視し、不正アクセスや異常な動作を検出する。Firebaseのエラーレポートを使って問題を早期に発見し対応する。
- **環境変数のセキュリティ**：機密情報（APIキーや認証情報など）は環境変数に安全に保存し、直接コード内でハードコーディングしない。FirebaseのConfigを利用すると管理が可能。
>参照リンク：https://firebase.google.com/docs/functions?hl=ja

## 3. データベースのセキュリティ (Firebase Realtime Database)
- **セキュリティルールの設定**：Firebase Realtime Databaseのセキュリティルールを厳密に設定し、特定のユーザーのみが必要なデータにアクセスできるようにする。読み取り・書き込みの許可をユーザーの認証状態や権限に基づいて制限する。
- **データ検証**：データが保存される前に検証するためのルールを作成し、入力形式や範囲の制約を設ける。これにより、不正なデータの挿入を防ぐ。
- **定期バックアップ**：重要データのバックアップを定期的に取得し、バックアップの保管場所にも適切なアクセス制御を行う。
- **復元プロセスの確立**：？
- **リアルタイムデータの暗号化**：データの送信にはTLSを使用することで、ネットワーク上での盗聴を防止。さらに、Firebaseが提供する暗号化オプションを利用して、保存データの暗号化も実施する。
- **機密データの暗号化**：機密情報は保存前に暗号化し、直接保存を避ける。
>参照リンク：https://firebase.google.com/docs/database?hl=ja

## 4. 画像保存 (Firebase Cloud Storage)
- **セキュリティルールの設定**：Cloud Storageのアクセスルールを厳格に設定し、認証済みユーザーだけが自分の画像にアクセスできるようにする。不要な読み取り・書き込み権限は避ける。
- **ファイル名の非公開**：ファイル名に個人情報や予測可能な情報を含めないようにし、UUIDなどを使用してファイル名を難読化する。
- **ファイルのスキャン**：アップロードされた画像に対してウイルススキャンや内容検査を行い、不正なファイルのアップロードを防ぐ。Cloud Functionsを用いた自動スキャンも検討する。
- **暗号化**：保存されるファイルにはデフォルトで暗号化を適用し、機密性が高いファイルについては、追加の暗号化プロセスを導入する。
- **ファイルURLの有効期限管理**：ファイルアクセス用のURLに短期間の有効期限を設定し、外部に漏洩しても長期間使用されないようにする。
>参照リンク：https://firebase.google.com/docs/storage?hl=ja

## 5. 通知サービス (Firebase Cloud Messaging)
- **メッセージの暗号化**：Firebase Cloud Messaging（FCM）では暗号化された通信が基本ですが、追加の対策として重要な通知にはデータの暗号化を考慮する。
- **メッセージ権限の管理**：特定のユーザーやデバイスにのみメッセージを送信するために、トークンを適切に管理し、第三者がトークンを悪用して通知を送信できないようにする。
- **通知の管理**：設定変更やログインのような重要通知はオフにできないようにし、ユーザーが常に確認できるように通知の種類を区別する。
- **リアルタイム通知制御**：ユーザーの通知設定に応じて送信する通知の範囲や内容を調整することで、通知によるプライバシーリスクを最小化。
>参照リンク：https://firebase.google.com/docs/cloud-messaging?hl=ja

## 6. ドメインセキュリティ (Firebase Hosting)
- **HTTPSの有効化**：Firebase Hostingでは、すべてのデプロイされたサイトに自動的にHTTPS（SSL/TLS証明書）が適用される。手動で証明書を設定する必要はない。
- **カスタムドメインの設定**：Firebase Hostingでカスタムドメインを設定できる。ドメイン名をFirebaseに接続することで、Firebase Hostingのセキュリティ機能を利用したセキュアな通信を確保する。ドメイン設定後に、Firebaseが自動的にSSL/TLS証明書を発行し、HTTPSでのアクセスを強制する。
- **ドメイン所有権の保護**：Firebase Hosting自体では、所有権を保護する機能はなくて、ドメイン名を管理するレジストラを利用して、ドメインロック機能を有効にすることで、不正なドメイン移管を防ぐこと。
- **SSL/TLS証明書の管理**：Firebase Hostingでは、SSL/TLS証明書の管理がFirebaseによって自動的に行われる。カスタムドメインに対して無料のSSL証明書を発行し、HTTPS通信を強制する。この証明書はFirebase側で管理されるため、手動で証明書を発行したり、更新したりする必要はない。
- **DNSの設定**：DNSプロバイダー側でDNSSECを有効化すること。
- **定期的な監視とアラート**：Firebase Hosting自体に定期的な監視機能は組み込まれていなくて、DNSレコードやドメイン設定に変更があった場合、利用しているDNSプロバイダーでアラートを設定することができる。
>参照リンク：https://firebase.google.com/docs/app-hosting?hl=ja

## 7. 全体的なセキュリティ対策
